# Prometheus

#### Задача

Настроить дашборд с 4-мя графиками

    память;
    процессор;
    диск;
    сеть.

Настроить на одной из систем:

    zabbix (использовать screen (комплексный экран);
    prometheus - grafana.


#### Решение 

1.Создадим сервер

Необходимо  создать свой secrets.yml в котором буду отписаны ваши авторизационные данные для подключения в виртуализацию, а так же для авторизации в Prometheus

Ниже предоставлен список переменных для secrets.yml
```bash
proxmox_host: 
proxmox_user: 
proxmox_password: 
proxmox_token: 
proxmox_token_secret:
grafana_user: 
grafana_password: 
```
Не забываем зашифровать  данные с помощью ansible-vault

```bash
jecka@debian:~/git/Prometheus$ ansible-vault encrypt  secrets.yml 
New Vault password: 
Confirm New Vault password: 
Encryption successful
```

Выполняем  разворачивание виртуальной машины из шаблона

```bash
ansible-playbook create_vm.yml --ask-vault-pass
```

<details><summary><code>Код выполнения</code></summary>

```bash

jecka@debian:~/git/Prometheus$ ansible-playbook create_vm.yml --ask-vault-pass
Vault password: 

PLAY [Creeate vms on Proxmox] *****************************************************************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************************************************************************************************************************
[WARNING]: Host 'pve' is using the discovered Python interpreter at '/usr/bin/python3.11', but future installation of another Python interpreter could cause a different interpreter to be discovered. See https://docs.ansible.com/ansible-core/devel/reference_appendices/interpreter_discovery.html for more information.
ok: [pve]

TASK [Install python] *************************************************************************************************************************************************************************************************************************************************************************************************
ok: [pve]

TASK [INstall pip modules] ********************************************************************************************************************************************************************************************************************************************************************************************
ok: [pve]

TASK [Install pip modules] ********************************************************************************************************************************************************************************************************************************************************************************************
ok: [pve]

TASK [Install pip modules] ********************************************************************************************************************************************************************************************************************************************************************************************
ok: [pve]

TASK [Clone KVM VM 1 from template] ***********************************************************************************************************************************************************************************************************************************************************************************
changed: [pve]

TASK [Start VM] *******************************************************************************************************************************************************************************************************************************************************************************************************
changed: [pve] => (item={'name_of_vm': 'my-vm1'})

PLAY RECAP ************************************************************************************************************************************************************************************************************************************************************************************************************
pve                        : ok=7    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
```

</ul></details>


Далее выполним непосредственно установку Prometheus + Grafana
Не забываем, что некоторые ресурсы недоступны с определенных ip  и  находим обходы которые не будут описаны тут.  

Запускаем playbook 

```bash
jecka@debian:~/git/Prometheus$ ansible-playbook Install_prom_grafana.yml --ask-vault-pass
```

<details><summary><code>Установка на сервер prometheus+grafana</code></summary>

```bash
jecka@debian:~/git/Prometheus$ ansible-playbook Install_prom_grafana.yml --ask-vault-pass
Vault password: 

PLAY [install  & config prometheus] ***********************************************************************************************************************************************************************************************************************************************************************************

TASK [Gathering Facts] ************************************************************************************************************************************************************************************************************************************************************************************************
[WARNING]: Host 'my-vm1' is using the discovered Python interpreter at '/usr/bin/python3.12', but future installation of another Python interpreter could cause a different interpreter to be discovered. See https://docs.ansible.com/ansible-core/devel/reference_appendices/interpreter_discovery.html for more information.
ok: [my-vm1]

TASK [Update apt package cache] ***************************************************************************************************************************************************************************************************************************************************************************************
changed: [my-vm1]

TASK [Install prometheus] *********************************************************************************************************************************************************************************************************************************************************************************************
changed: [my-vm1]

TASK [Add an Apt signing key to a specific keyring file] **************************************************************************************************************************************************************************************************************************************************************
changed: [my-vm1]

TASK [add repo grafana | apt source] **********************************************************************************************************************************************************************************************************************************************************************************
changed: [my-vm1]

TASK [Update apt package cache] ***************************************************************************************************************************************************************************************************************************************************************************************
changed: [my-vm1]

TASK [Install grafana] ************************************************************************************************************************************************************************************************************************************************************************************************
changed: [my-vm1]

TASK [ensure grafana service started] *********************************************************************************************************************************************************************************************************************************************************************************
changed: [my-vm1]

TASK [add datasource] *************************************************************************************************************************************************************************************************************************************************************************************************
changed: [my-vm1]

TASK [Import Grafana dashboard Zabbix] ********************************************************************************************************************************************************************************************************************************************************************************
changed: [my-vm1]

PLAY RECAP ************************************************************************************************************************************************************************************************************************************************************************************************************
my-vm1                     : ok=10   changed=4    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

jecka@debian:~/git/Prometheus$ 
```

</ul></details>

<details><summary><code>Открытые порты на  сервере с prometheus+grafana</code></summary>
<br>

```bash
ansible@my-vm1:~$ ss -tulnp
Netid                           State                            Recv-Q                           Send-Q                                                         Local Address:Port                                                      Peer Address:Port                           Process                           
udp                             UNCONN                           0                                0                                                                 127.0.0.54:53                                                             0.0.0.0:*                                                                
udp                             UNCONN                           0                                0                                                              127.0.0.53%lo:53                                                             0.0.0.0:*                                                                
udp                             UNCONN                           0                                0                                                          192.168.1.29%eth0:68                                                             0.0.0.0:*                                                                
tcp                             LISTEN                           0                                4096                                                                 0.0.0.0:22                                                             0.0.0.0:*                                                                
tcp                             LISTEN                           0                                4096                                                           127.0.0.53%lo:53                                                             0.0.0.0:*                                                                
tcp                             LISTEN                           0                                4096                                                              127.0.0.54:53                                                             0.0.0.0:*                                                                
tcp                             LISTEN                           0                                4096                                                                    [::]:22                                                                [::]:*                                                                
tcp                             LISTEN                           0                                4096                                                                       *:3000                                                                 *:*                                                                
tcp                             LISTEN                           0                                4096                                                                       *:9090                                                                 *:*                                                                
tcp                             LISTEN                           0                                4096                                                                       *:9100                                                                 *:*                                                                
ansible@my-vm1:~$ 

```
</ul></details>

![Страницы с запущенной Grafana](https://raw.githubusercontent.com/jecka2/Prometheus/refs/head/main/Grafana.png)
<br>
![Добавленный источник данных  в Grafana при установке](https://raw.githubusercontent.com/jecka2/Prometheus/refs/head/main/Database_grafana.png)